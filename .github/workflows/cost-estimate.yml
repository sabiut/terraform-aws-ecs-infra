name: 'Cost Estimation'

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'terraform/**'

env:
  WORKING_DIR: './terraform'

permissions:
  contents: read
  pull-requests: write

jobs:
  infracost:
    name: 'Infrastructure Cost Estimation'
    runs-on: ubuntu-latest

    steps:
    - name: Setup Infracost
      uses: infracost/setup-infracost@v2
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}

    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: '${{ github.event.pull_request.base.ref }}'

    - name: Generate Infracost cost estimate baseline
      run: |
        infracost breakdown \
          --path=${{ env.WORKING_DIR }} \
          --format=json \
          --out-file=/tmp/infracost-base.json

    - name: Checkout PR branch
      uses: actions/checkout@v4

    - name: Generate Infracost diff
      run: |
        infracost diff \
          --path=${{ env.WORKING_DIR }} \
          --format=json \
          --compare-to=/tmp/infracost-base.json \
          --out-file=/tmp/infracost.json

    - name: Post Infracost comment
      run: |
        infracost comment github \
          --path=/tmp/infracost.json \
          --repo=$GITHUB_REPOSITORY \
          --github-token=${{ github.token }} \
          --pull-request=${{ github.event.pull_request.number }} \
          --behavior=update

    - name: Generate Cost Report
      run: |
        echo "### Cost Estimation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        infracost output \
          --path=/tmp/infracost.json \
          --format=table \
          --show-skipped >> $GITHUB_STEP_SUMMARY